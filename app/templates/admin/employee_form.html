{% extends "layouts/admin_base.html" %}

{% block title %}{{ 'S·ª≠a' if employee else 'Th√™m m·ªõi' }} nh√¢n vi√™n{% endblock %}

{% block head %}
{{ super() }}
<style>
    .form-page {
        width: min(1100px, 100%);
        margin: 0 auto;
        padding: 0 12px 40px;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 24px;
    }
    .page-header h1 {
        margin: 0;
        font-size: 26px;
        color: #1f2a44;
    }
    .form-container {
        background: #ffffff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(15, 82, 155, 0.08);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .form-section {
        background: #fbfcff;
        border: 1px solid #e7edfb;
        border-radius: 14px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .form-section + .form-section {
        margin-top: 4px;
    }
    .section-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 8px;
    }
    .section-header h2 {
        margin: 0;
        font-size: 18px;
        color: #1f2a44;
    }
    .section-subtitle {
        margin: 0;
        font-size: 13px;
        color: #6c7a99;
    }
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
    }
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    .form-group label {
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
    }
    .form-group .form-control,
    .form-group select,
    .form-group textarea {
        border-radius: 10px;
        border: 1px solid #d9e2f3;
        padding: 10px 12px;
        font-size: 14px;
        transition: border 0.2s ease, box-shadow 0.2s ease;
        background: #fff;
    }
    .form-group .form-control:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }
    .form-group textarea {
        resize: vertical;
        min-height: 120px;
    }
    .form-group .helper-text {
        font-size: 12px;
        color: #7f8c9f;
    }
    .form-group.inline-checkbox {
        flex-direction: row;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px dashed #cfd9f0;
        background: #f6f8ff;
    }
    .form-group.inline-checkbox input[type="checkbox"] {
        transform: scale(1.2);
    }
    .form-group.span-2 {
        grid-column: span 2;
    }
    @media (max-width: 600px) {
        .form-group.span-2 {
            grid-column: span 1;
        }
    }
    .form-actions {
        display: flex;
        justify-content: flex-end;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 8px;
    }
    .face-section {
        border-top: 2px solid #e7edfb;
        padding-top: 24px;
        margin-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }
    .face-card {
        background: #fbfcff;
        border: 1px solid #e7edfb;
        border-radius: 14px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }
    .face-card h3,
    .face-card h4 {
        margin: 0;
        color: #2c3e50;
    }
    .face-card h3 {
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .face-info,
    .face-alert {
        padding: 12px;
        border-radius: 10px;
        font-size: 13px;
        line-height: 1.6;
    }
    .face-info {
        background: #f5f5f5;
        color: #555;
    }
    .face-alert {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        color: #0d47a1;
    }
    .face-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: flex-start;
    }
    .face-video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
    }
    .video-preview {
        display: none;
        flex-direction: column;
        gap: 12px;
    }
    .video-frame {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        background: #000;
        overflow: hidden;
    }
    .video-frame video {
        width: 100%;
        height: auto;
        display: block;
    }
    .recording-panel {
        display: none;
    }
    .recording-panel .recording-alert {
        padding: 12px;
        background: #ffebee;
        border-left: 4px solid #f44336;
        border-radius: 10px;
        color: #c62828;
    }
    .recorded-controls {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .recorded-controls input {
        max-width: 420px;
    }
    .recorded-controls .inline-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }
    .face-status {
        margin-bottom: 12px;
    }
    .face-empty-message {
        font-size: 13px;
        color: #6c7a99;
    }
    @media (max-width: 992px) {
        .form-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }
    @media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .form-container {
            padding: 18px;
        }
        .face-actions {
            flex-direction: column;
        }
        .face-actions .btn {
            width: 100%;
            text-align: center;
        }
    }
    @media (max-width: 600px) {
        .form-group.span-2 {
            grid-column: span 1;
        }
        .form-actions {
            flex-direction: column;
            align-items: stretch;
        }
        .form-actions .btn {
            width: 100%;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="form-page">
    <div class="page-header">
        <h1>{{ 'S·ª≠a' if employee else 'Th√™m m·ªõi' }} nh√¢n vi√™n</h1>
        <a href="{{ url_for('admin.employees') }}" class="btn btn-secondary">Quay l·∫°i</a>
    </div>

{% set current_department = request.form.get('department_id', employee.department_id if employee else '') %}
{% set is_active_checked = (request.method == 'POST' and request.form.get('is_active') is not none) or (request.method != 'POST' and (not employee or employee.is_active)) %}

    <form method="POST" class="form-container">
    <div class="form-section">
        <div class="section-header">
            <div>
                <h2>Th√¥ng tin c∆° b·∫£n</h2>
                <p class="section-subtitle">ƒêi·ªÅn c√°c th√¥ng tin ƒë·ªãnh danh v√† thu·ªôc t√≠nh nh√¢n vi√™n.</p>
            </div>
            {% if employee %}
            <span class="section-subtitle">M√£ hi·ªán t·∫°i: <strong>{{ employee.employee_code }}</strong></span>
            {% endif %}
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="employee_code">M√£ nh√¢n vi√™n *</label>
                <input type="text"
                       name="employee_code"
                       id="employee_code"
                       class="form-control"
                       value="{{ request.form.get('employee_code', employee.employee_code if employee else '') }}"
                       placeholder="V√≠ d·ª•: NV001"
                       required>
                <small class="helper-text">M√£ d√πng cho ch·∫•m c√¥ng, b√°o c√°o v√† t√¨m ki·∫øm.</small>
            </div>
            <div class="form-group">
                <label for="name">T√™n nh√¢n vi√™n *</label>
                <input type="text"
                       name="name"
                       id="name"
                       class="form-control"
                       value="{{ request.form.get('name', employee.name if employee else '') }}"
                       placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A"
                       required>
            </div>
            <div class="form-group">
                <label for="department_id">Ph√≤ng ban</label>
                <select name="department_id" id="department_id" class="form-control">
                    <option value="">-- Ch·ªçn ph√≤ng ban --</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}"
                                {% if current_department|string == dept.id|string %}selected{% endif %}>
                            {{ dept.name }}{% if dept.code %} ({{ dept.code }}){% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="position">Ch·ª©c v·ª•</label>
                <input type="text"
                       name="position"
                       id="position"
                       class="form-control"
                       value="{{ request.form.get('position', employee.position if employee else '') }}"
                       placeholder="V√≠ d·ª•: Developer, Manager, ...">
            </div>
            <div class="form-group">
                <label for="hire_date">Ng√†y v√†o l√†m</label>
                <input type="date"
                       name="hire_date"
                       id="hire_date"
                       class="form-control"
                       value="{{ request.form.get('hire_date', employee.hire_date.strftime('%Y-%m-%d') if employee and employee.hire_date else '') }}">
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="section-header">
            <div>
                <h2>Li√™n h·ªá</h2>
                <p class="section-subtitle">Th√¥ng tin ƒë·ªÉ g·ª≠i th√¥ng b√°o v√† li√™n l·∫°c nhanh.</p>
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email"
                       name="email"
                       id="email"
                       class="form-control"
                       value="{{ request.form.get('email', employee.email if employee else '') }}"
                       placeholder="ten.nhanvien@congty.com">
                <small class="helper-text">D√πng ƒë·ªÉ g·ª≠i th√¥ng b√°o t·ª± ƒë·ªông (kh√¥ng b·∫Øt bu·ªôc).</small>
            </div>
            <div class="form-group">
                <label for="phone">ƒêi·ªán tho·∫°i</label>
                <input type="text"
                       name="phone"
                       id="phone"
                       class="form-control"
                       value="{{ request.form.get('phone', employee.phone if employee else '') }}"
                       pattern="[0-9+\-\s()]+"
                       placeholder="V√≠ d·ª•: 0123456789">
                <small class="helper-text">Ch·ªâ nh·∫≠p s·ªë, d·∫•u +, -, kho·∫£ng tr·∫Øng v√† d·∫•u ngo·∫∑c.</small>
            </div>
        </div>
    </div>

    <div class="form-section">
        <div class="section-header">
            <div>
                <h2>Tr·∫°ng th√°i & ghi ch√∫</h2>
                <p class="section-subtitle">C·∫≠p nh·∫≠t t√¨nh tr·∫°ng l√†m vi·ªác v√† th√¥ng tin b·ªï sung.</p>
            </div>
        </div>
        <div class="form-grid">
            <div class="form-group inline-checkbox">
                <input type="checkbox"
                       name="is_active"
                       id="is_active"
                       {% if is_active_checked %}checked{% endif %}>
                <div>
                    <label for="is_active" style="margin: 0;">ƒêang ho·∫°t ƒë·ªông</label>
                    <div class="helper-text">B·ªè ch·ªçn khi nh√¢n vi√™n ƒë√£ ngh·ªâ vi·ªác ho·∫∑c t·∫°m ng∆∞ng.</div>
                </div>
            </div>
            <div class="form-group span-2">
                <label for="notes">Ghi ch√∫</label>
                <textarea name="notes"
                          id="notes"
                          class="form-control"
                          rows="4"
                          placeholder="Ghi ch√∫ v·ªÅ nh√¢n vi√™n (th√¥ng tin b·ªï sung, l∆∞u √Ω, v.v.)">{{ request.form.get('notes', employee.notes if employee and employee.notes else '') }}</textarea>
                <small class="helper-text">Th√¥ng tin b·ªï sung v·ªÅ nh√¢n vi√™n (kh√¥ng b·∫Øt bu·ªôc).</small>
            </div>
        </div>
    </div>
    <!-- Face Encoding Management Section -->
    {% if employee %}
    <div class="face-section">
        <h3>üì∑ Qu·∫£n l√Ω Face Recognition (Multi-Embedding)</h3>

        <div class="face-card">
            <div id="embeddingsList">
                <h4>Danh s√°ch Face Embeddings</h4>
                <div id="embeddingsContainer" class="face-info">
                    <span id="embeddingsLoading">ƒêang t·∫£i...</span>
                </div>
            </div>

            <div id="faceEncodingStatus" class="face-status" style="display: none;"></div>

            <div class="face-upload-section">
                <h4>Th√™m Face Embedding M·ªõi</h4>
                <p class="section-subtitle">Ch·ª•p 2-3 ·∫£nh khu√¥n m·∫∑t t·ª´ webcam</p>

                <div class="face-alert">
                    <strong>üí° H∆∞·ªõng d·∫´n:</strong> Ch·ª•p 2-3 ·∫£nh v·ªõi c√°c g√≥c ƒë·ªô kh√°c nhau (ch√≠nh di·ªán, h∆°i nghi√™ng tr√°i/ph·∫£i) ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c nh·∫≠n di·ªán. M·ªói ·∫£nh s·∫Ω ƒë∆∞·ª£c l∆∞u nh∆∞ m·ªôt embedding ri√™ng.
                </div>

                <div class="face-actions">
                    <button type="button"
                            id="btnStartCamera"
                            onclick="startCamera()"
                            class="btn btn-primary">
                        üì∑ B·∫≠t Camera
                    </button>
                    <button type="button"
                            id="btnStopCamera"
                            onclick="stopCamera()"
                            class="btn btn-secondary"
                            style="display: none;">
                        üõë T·∫Øt Camera
                    </button>
                    <button type="button"
                            id="btnCapture"
                            onclick="capturePhoto()"
                            class="btn btn-success"
                            style="display: none;">
                        üì∏ Ch·ª•p ·∫£nh
                    </button>
                </div>

                <div id="captureProgress" style="display: none; margin-top: 16px;">
                    <div style="padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 8px; color: #0d47a1;">
                        <strong>üìä Ti·∫øn ƒë·ªô:</strong> 
                        <span id="captureCount">0</span>/3 ·∫£nh ƒë√£ ch·ª•p
                        <div style="margin-top: 8px; font-size: 13px;">
                            <span id="captureStatus">H√£y ch·ª•p th√™m ·∫£nh ƒë·ªÉ ƒë·∫°t ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t</span>
                        </div>
                    </div>
                </div>

                <small class="face-empty-message">
                    B·∫≠t camera v√† ƒë·∫£m b·∫£o khu√¥n m·∫∑t r√µ r√†ng, ch·ªâ c√≥ 1 ng∆∞·ªùi trong khung h√¨nh. Nh·∫•n "Ch·ª•p ·∫£nh" ƒë·ªÉ ch·ª•p t·ª´ng ·∫£nh. Khuy·∫øn ngh·ªã: ch·ª•p 2-3 ·∫£nh v·ªõi c√°c g√≥c ƒë·ªô kh√°c nhau.
                </small>

                <div class="face-video-grid">
                    <div id="cameraPreview" class="video-preview">
                        <div class="video-frame">
                            <video id="videoElement" autoplay playsinline></video>
                            <canvas id="canvasElement" style="display: none;"></canvas>
                        </div>
                    </div>

                    <div id="capturedPhotosContainer" style="display: none; grid-column: 1 / -1;">
                        <h5 style="margin: 16px 0 12px 0; color: #2c3e50;">·∫¢nh ƒë√£ ch·ª•p:</h5>
                        <div id="capturedPhotosList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;"></div>
                        <div class="recorded-controls">
                            <div>
                                <label for="photosDescription">M√¥ t·∫£ chung cho t·∫•t c·∫£ embeddings:</label>
                                <input type="text"
                                       id="photosDescription"
                                       class="form-control"
                                       placeholder="V√≠ d·ª•: ƒêƒÉng k√Ω l·∫ßn ƒë·∫ßu, bu·ªïi s√°ng, etc.">
                            </div>
                            <label class="inline-checkbox">
                                <input type="checkbox" id="setFirstAsPrimary">
                                <span>ƒê·∫∑t ·∫£nh ƒë·∫ßu ti√™n l√†m embedding ch√≠nh</span>
                            </label>
                            <div class="face-actions" style="gap: 8px;">
                                <button type="button"
                                        onclick="confirmPhotosRegister()"
                                        id="btnConfirmRegister"
                                        class="btn btn-success">
                                    ‚úì X√°c nh·∫≠n & T·∫°o Embeddings
                                </button>
                                <button type="button"
                                        onclick="clearCapturedPhotos()"
                                        class="btn btn-secondary">
                                    X√≥a t·∫•t c·∫£ & Ch·ª•p l·∫°i
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="faceUploadMessage" class="face-status" style="display: none;"></div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="face-section">
        <h3>üì∑ Qu·∫£n l√Ω Face Recognition</h3>
        <div class="face-alert">
            Sau khi t·∫°o nh√¢n vi√™n, b·∫°n c√≥ th·ªÉ quay l·∫°i ƒë·ªÉ ch·ª•p ·∫£nh t·ª´ webcam v√† ƒëƒÉng k√Ω face encoding.
        </div>
    </div>
    {% endif %}

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">{{ 'C·∫≠p nh·∫≠t' if employee else 'T·∫°o m·ªõi' }}</button>
        <a href="{{ url_for('admin.employees') }}" class="btn btn-secondary">H·ªßy</a>
    </div>
    </form>
</div>

{% if employee %}
<script>
let cameraStream = null;
let capturedPhotos = []; // Array to store captured photos (base64)
const employeeCode = '{{ employee.employee_code }}';
const MIN_PHOTOS = 2; // Minimum recommended photos
const MAX_PHOTOS = 3; // Maximum recommended photos

// Load embeddings list on page load
document.addEventListener('DOMContentLoaded', function() {
    loadEmbeddings();
});

// Load embeddings list
async function loadEmbeddings() {
    const container = document.getElementById('embeddingsContainer');
    container.innerHTML = '<div style="padding: 12px; background: #f5f5f5; border-radius: 8px; color: #666;">ƒêang t·∫£i...</div>';
    
    try {
        const response = await fetch(`/api/face/embeddings/${employeeCode}`);
        const result = await response.json();
        
        if (result.success && result.embeddings && result.embeddings.length > 0) {
            let html = '<div style="display: grid; gap: 12px;">';
            
            result.embeddings.forEach(embedding => {
                const isPrimary = embedding.is_primary ? '<span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">PRIMARY</span>' : '';
                const variantLabel = {
                    'default': 'M·∫∑c ƒë·ªãnh',
                    'no_glasses': 'Kh√¥ng k√≠nh',
                    'with_glasses': 'C√≥ k√≠nh',
                    'profile_left': 'G√≥c tr√°i',
                    'profile_right': 'G√≥c ph·∫£i',
                    'other': 'Kh√°c'
                }[embedding.variant_type] || embedding.variant_type;
                
                html += `
                    <div style="padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 4px;">
                                ${variantLabel} ${isPrimary}
                            </div>
                            ${embedding.description ? `<div style="font-size: 12px; color: #666; margin-bottom: 4px;">${embedding.description}</div>` : ''}
                            <div style="font-size: 11px; color: #999;">
                                Lo·∫°i: ${embedding.embedding_type} | 
                                T·∫°o: ${new Date(embedding.created_at).toLocaleString('vi-VN')}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${!embedding.is_primary ? `
                                <button onclick="setPrimaryEmbedding(${embedding.id})" 
                                        class="btn btn-sm" 
                                        style="padding: 6px 12px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ‚≠ê ƒê·∫∑t l√†m ch√≠nh
                                </button>
                            ` : ''}
                            <button onclick="deleteEmbedding(${embedding.id})" 
                                    class="btn btn-sm" 
                                    style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                üóëÔ∏è X√≥a
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            
            // Update status
            const statusDiv = document.getElementById('faceEncodingStatus');
            statusDiv.innerHTML = `
                <div class="alert alert-success" style="padding: 12px; border-radius: 8px; background: #e8f5e9; color: #4caf50; border-left: 4px solid #4caf50;">
                    <strong>‚úì ƒê√£ c√≥ ${result.total_embeddings} face embedding(s)</strong>
                    <p style="margin: 8px 0 0 0; font-size: 13px;">Nh√¢n vi√™n n√†y c√≥ th·ªÉ s·ª≠ d·ª•ng face recognition ƒë·ªÉ ch·∫•m c√¥ng.</p>
                </div>
            `;
            statusDiv.style.display = 'block';
        } else {
            container.innerHTML = `
                <div style="padding: 12px; background: #ffebee; color: #f44336; border-radius: 8px; border-left: 4px solid #f44336;">
                    <strong>‚ö† Ch∆∞a c√≥ face embedding</strong>
                    <p style="margin: 8px 0 0 0; font-size: 13px;">H√£y ch·ª•p ·∫£nh t·ª´ webcam ƒë·ªÉ ƒëƒÉng k√Ω face embedding ƒë·∫ßu ti√™n.</p>
                </div>
            `;
            
            const statusDiv = document.getElementById('faceEncodingStatus');
            statusDiv.innerHTML = `
                <div class="alert alert-danger" style="padding: 12px; border-radius: 8px; background: #ffebee; color: #f44336; border-left: 4px solid #f44336;">
                    <strong>‚ö† Ch∆∞a c√≥ face encoding</strong>
                    <p style="margin: 8px 0 0 0; font-size: 13px;">Nh√¢n vi√™n n√†y ch∆∞a th·ªÉ s·ª≠ d·ª•ng face recognition. H√£y ch·ª•p ·∫£nh tr·ª±c ti·∫øp t·ª´ webcam ƒë·ªÉ ƒëƒÉng k√Ω.</p>
                </div>
            `;
            statusDiv.style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading embeddings:', error);
        container.innerHTML = `
            <div style="padding: 12px; background: #ffebee; color: #f44336; border-radius: 8px;">
                L·ªói khi t·∫£i danh s√°ch embeddings: ${error.message}
            </div>
        `;
    }
}

// Set primary embedding
async function setPrimaryEmbedding(embeddingId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·∫∑t embedding n√†y l√†m embedding ch√≠nh?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/face/embedding/${embeddingId}/primary`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('‚úì ƒê√£ ƒë·∫∑t l√†m embedding ch√≠nh!', 'success');
            loadEmbeddings(); // Reload list
        } else {
            showMessage('‚úó ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error setting primary:', error);
        showMessage('‚úó C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
    }
}

// Delete embedding
async function deleteEmbedding(embeddingId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a embedding n√†y?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/face/embedding/${embeddingId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('‚úì ƒê√£ x√≥a embedding!', 'success');
            loadEmbeddings(); // Reload list
        } else {
            showMessage('‚úó ' + result.message, 'error');
        }
    } catch (error) {
        console.error('Error deleting embedding:', error);
        showMessage('‚úó C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
    }
}

// Start camera
async function startCamera() {
    try {
        const video = document.getElementById('videoElement');
        const cameraPreview = document.getElementById('cameraPreview');
        const btnStart = document.getElementById('btnStartCamera');
        const btnStop = document.getElementById('btnStopCamera');
        const btnCapture = document.getElementById('btnCapture');
        
        // Request camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'user',
                width: { ideal: 640 },
                height: { ideal: 480 }
            },
            audio: false
        });
        
        video.srcObject = cameraStream;
        cameraPreview.style.display = 'flex';
        btnStart.style.display = 'none';
        btnStop.style.display = 'inline-block';
        btnCapture.style.display = 'inline-block';
        
        showMessage('Camera ƒë√£ ƒë∆∞·ª£c b·∫≠t th√†nh c√¥ng. H√£y ƒë·∫£m b·∫£o khu√¥n m·∫∑t r√µ r√†ng trong khung h√¨nh. Nh·∫•n "Ch·ª•p ·∫£nh" ƒë·ªÉ ch·ª•p t·ª´ng ·∫£nh.', 'success');
    } catch (error) {
        console.error('Camera error:', error);
        showMessage('Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p v√† ƒë·∫£m b·∫£o camera kh√¥ng ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng b·ªüi ·ª©ng d·ª•ng kh√°c.', 'error');
    }
}

// Stop camera
function stopCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
        
        const video = document.getElementById('videoElement');
        const cameraPreview = document.getElementById('cameraPreview');
        const btnStart = document.getElementById('btnStartCamera');
        const btnStop = document.getElementById('btnStopCamera');
        const btnCapture = document.getElementById('btnCapture');
        
        video.srcObject = null;
        cameraPreview.style.display = 'none';
        btnStart.style.display = 'inline-block';
        btnStop.style.display = 'none';
        btnCapture.style.display = 'none';
        
        // Hide captured photos container
        document.getElementById('capturedPhotosContainer').style.display = 'none';
        document.getElementById('captureProgress').style.display = 'none';
    }
}

// Capture photo from video stream
function capturePhoto() {
    if (!cameraStream) {
        showMessage('Vui l√≤ng b·∫≠t camera tr∆∞·ªõc!', 'error');
        return;
    }
    
    if (capturedPhotos.length >= MAX_PHOTOS) {
        showMessage(`ƒê√£ ch·ª•p ƒë·ªß ${MAX_PHOTOS} ·∫£nh. Vui l√≤ng x√°c nh·∫≠n ho·∫∑c x√≥a ·∫£nh ƒë·ªÉ ch·ª•p l·∫°i.`, 'info');
        return;
    }
    
    try {
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size to match video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // Draw current video frame to canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert canvas to base64 image
        const imageData = canvas.toDataURL('image/jpeg', 0.92);
        
        // Add to captured photos array
        capturedPhotos.push(imageData);
        
        // Update UI
        updateCapturedPhotosUI();
        updateCaptureProgress();
        
        // Show success message
        if (capturedPhotos.length < MIN_PHOTOS) {
            showMessage(`ƒê√£ ch·ª•p ${capturedPhotos.length}/${MIN_PHOTOS} ·∫£nh. Khuy·∫øn ngh·ªã ch·ª•p th√™m ƒë·ªÉ ƒë·∫°t ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t.`, 'info');
        } else {
            showMessage(`ƒê√£ ch·ª•p ${capturedPhotos.length} ·∫£nh. B·∫°n c√≥ th·ªÉ ch·ª•p th√™m ho·∫∑c x√°c nh·∫≠n ngay.`, 'success');
        }
        
    } catch (error) {
        console.error('Capture error:', error);
        showMessage('C√≥ l·ªói x·∫£y ra khi ch·ª•p ·∫£nh: ' + error.message, 'error');
    }
}

// Update captured photos UI
function updateCapturedPhotosUI() {
    const container = document.getElementById('capturedPhotosContainer');
    const list = document.getElementById('capturedPhotosList');
    
    if (capturedPhotos.length === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    list.innerHTML = '';
    
    capturedPhotos.forEach((photo, index) => {
        const photoDiv = document.createElement('div');
        photoDiv.style.cssText = 'position: relative; border: 2px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #000;';
        
        const img = document.createElement('img');
        img.src = photo;
        img.style.cssText = 'width: 100%; height: auto; display: block;';
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; background: rgba(244, 67, 54, 0.9); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;';
        deleteBtn.onclick = () => removePhoto(index);
        
        const label = document.createElement('div');
        label.textContent = `·∫¢nh ${index + 1}`;
        label.style.cssText = 'position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.7); color: white; padding: 4px; font-size: 12px; text-align: center;';
        
        photoDiv.appendChild(img);
        photoDiv.appendChild(deleteBtn);
        photoDiv.appendChild(label);
        list.appendChild(photoDiv);
    });
}

// Remove a photo from the array
function removePhoto(index) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?')) {
        capturedPhotos.splice(index, 1);
        updateCapturedPhotosUI();
        updateCaptureProgress();
        showMessage('ƒê√£ x√≥a ·∫£nh. B·∫°n c√≥ th·ªÉ ch·ª•p l·∫°i.', 'info');
    }
}

// Clear all captured photos
function clearCapturedPhotos() {
    if (capturedPhotos.length === 0) return;
    
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ ·∫£nh ƒë√£ ch·ª•p v√† ch·ª•p l·∫°i?')) {
        capturedPhotos = [];
        updateCapturedPhotosUI();
        updateCaptureProgress();
        document.getElementById('photosDescription').value = '';
        document.getElementById('setFirstAsPrimary').checked = false;
        showMessage('ƒê√£ x√≥a t·∫•t c·∫£ ·∫£nh. B·∫°n c√≥ th·ªÉ ch·ª•p l·∫°i.', 'info');
    }
}

// Update capture progress
function updateCaptureProgress() {
    const progressDiv = document.getElementById('captureProgress');
    const countSpan = document.getElementById('captureCount');
    const statusSpan = document.getElementById('captureStatus');
    
    if (capturedPhotos.length === 0) {
        progressDiv.style.display = 'none';
        return;
    }
    
    progressDiv.style.display = 'block';
    countSpan.textContent = capturedPhotos.length;
    
    if (capturedPhotos.length < MIN_PHOTOS) {
        statusSpan.textContent = `Khuy·∫øn ngh·ªã ch·ª•p th√™m ${MIN_PHOTOS - capturedPhotos.length} ·∫£nh n·ªØa ƒë·ªÉ ƒë·∫°t ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t.`;
        statusSpan.style.color = '#f57c00';
    } else if (capturedPhotos.length < MAX_PHOTOS) {
        statusSpan.textContent = `ƒê√£ ƒë·ªß s·ªë l∆∞·ª£ng t·ªëi thi·ªÉu. B·∫°n c√≥ th·ªÉ ch·ª•p th√™m ho·∫∑c x√°c nh·∫≠n ngay.`;
        statusSpan.style.color = '#4caf50';
    } else {
        statusSpan.textContent = `ƒê√£ ch·ª•p ƒë·ªß ${MAX_PHOTOS} ·∫£nh. B·∫°n c√≥ th·ªÉ x√°c nh·∫≠n ngay.`;
        statusSpan.style.color = '#4caf50';
    }
}

// Confirm and register face embeddings from captured photos
async function confirmPhotosRegister() {
    if (capturedPhotos.length === 0) {
        showMessage('Vui l√≤ng ch·ª•p √≠t nh·∫•t 1 ·∫£nh tr∆∞·ªõc!', 'error');
        return;
    }
    
    const messageDiv = document.getElementById('faceUploadMessage');
    messageDiv.style.display = 'block';
    messageDiv.innerHTML = '<div style="padding: 12px; background: #fff3cd; color: #856404; border-radius: 8px;">ƒêang x·ª≠ l√Ω ·∫£nh v√† t·∫°o embeddings...</div>';
    
    try {
        // Get description and primary setting
        const description = document.getElementById('photosDescription').value;
        const setFirstAsPrimary = document.getElementById('setFirstAsPrimary').checked;
        
        // Disable confirm button during processing
        const btnConfirm = document.getElementById('btnConfirmRegister');
        btnConfirm.disabled = true;
        btnConfirm.textContent = 'ƒêang x·ª≠ l√Ω...';
        
        let successCount = 0;
        let failCount = 0;
        let firstEmbeddingId = null;
        
        // Register each photo as a separate embedding
        for (let i = 0; i < capturedPhotos.length; i++) {
            try {
                const photo = capturedPhotos[i];
                // Remove data URL prefix if present
                const base64 = photo.includes(',') ? photo.split(',')[1] : photo;
                
                // Determine variant type based on photo index
                let variantType = 'default';
                if (i === 0) {
                    variantType = 'default';
                } else if (i === 1) {
                    variantType = 'profile_left';
                } else if (i === 2) {
                    variantType = 'profile_right';
                } else {
                    variantType = 'other';
                }
                
                // Create description for this photo
                let photoDescription = description || `·∫¢nh ${i + 1}`;
                if (description) {
                    photoDescription = `${description} (·∫¢nh ${i + 1})`;
                }
                
                // Call API to register face from photo
                const response = await fetch('/api/face/register-multi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        employee_code: employeeCode,
                        image: base64,
                        variant_type: variantType,
                        description: photoDescription,
                        set_as_primary: (setFirstAsPrimary && i === 0)
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    successCount++;
                    if (i === 0) {
                        firstEmbeddingId = result.embedding_id;
                    }
                } else {
                    failCount++;
                    console.error(`Failed to register photo ${i + 1}:`, result.message);
                }
            } catch (error) {
                failCount++;
                console.error(`Error processing photo ${i + 1}:`, error);
            }
        }
        
        // Re-enable button
        btnConfirm.disabled = false;
        btnConfirm.textContent = '‚úì X√°c nh·∫≠n & T·∫°o Embeddings';
        
        if (successCount > 0) {
            showMessage(`‚úì ƒê√£ t·∫°o th√†nh c√¥ng ${successCount} embedding(s) t·ª´ ${capturedPhotos.length} ·∫£nh!${failCount > 0 ? ` (${failCount} ·∫£nh th·∫•t b·∫°i)` : ''}`, 'success');
            // Stop camera
            stopCamera();
            // Clear captured photos
            capturedPhotos = [];
            updateCapturedPhotosUI();
            updateCaptureProgress();
            // Reload embeddings list
            setTimeout(() => {
                loadEmbeddings();
            }, 1000);
        } else {
            showMessage(`‚úó Kh√¥ng th·ªÉ t·∫°o embedding t·ª´ b·∫•t k·ª≥ ·∫£nh n√†o. Vui l√≤ng th·ª≠ l·∫°i.`, 'error');
        }
    } catch (error) {
        console.error('Error uploading photos:', error);
        showMessage('‚úó C√≥ l·ªói x·∫£y ra khi x·ª≠ l√Ω ·∫£nh: ' + error.message, 'error');
        
        // Re-enable button
        const btnConfirm = document.getElementById('btnConfirmRegister');
        btnConfirm.disabled = false;
        btnConfirm.textContent = '‚úì X√°c nh·∫≠n & T·∫°o Embeddings';
    }
}


function showMessage(message, type) {
    const messageDiv = document.getElementById('faceUploadMessage');
    let bgColor, textColor, borderColor;
    
    if (type === 'success') {
        bgColor = '#e8f5e9';
        textColor = '#4caf50';
        borderColor = '#4caf50';
    } else if (type === 'info') {
        bgColor = '#e3f2fd';
        textColor = '#2196f3';
        borderColor = '#2196f3';
    } else {
        bgColor = '#ffebee';
        textColor = '#f44336';
        borderColor = '#f44336';
    }
    
    messageDiv.innerHTML = `<div style="padding: 12px; background: ${bgColor}; color: ${textColor}; border-radius: 8px; border-left: 4px solid ${borderColor};">${message}</div>`;
    messageDiv.style.display = 'block';
}
</script>
{% endif %}
{% endblock %}

